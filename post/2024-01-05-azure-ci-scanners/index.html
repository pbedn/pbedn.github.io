<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.128.0"><title>Configure CI for Python app in Azure Devops (Pytest, Nexus IQ, SonarQube) &#183; Coding Notes</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.6/pure-min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.6/grids-responsive-min.css><link rel=stylesheet href=https://pbedn.github.io/css/side-menu.css><link rel=stylesheet href=https://pbedn.github.io/css/blackburn.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js></script><link rel="shortcut icon" href=https://pbedn.github.io/img/favicon.ico type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVR0TPVEEJ"></script><script>if(window.location.hostname!="localhost"){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JVR0TPVEEJ")}</script></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=https://pbedn.github.io/>PBedn</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://pbedn.github.io/><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://pbedn.github.io/archives/><i class='fa fa-list fa-fw'></i>Archives</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://pbedn.github.io/about/><i class='fa fa-user fa-fw'></i>About</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://pbedn.github.io/projects/><i class='fa fa-cog fa-fw'></i>Projects</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://pbedn.github.io/books/><i class='fa fa-book fa-fw'></i>Books</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://linkedin.com/in/pbedn target=_blank><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://github.com/pbedn target=_blank><i class="fa fa-github-square fa-fw"></i>GitHub</a></li></ul></div><div><div class=small-print><small>&#169; 2021 Pawel Bednarz</small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div></div><div><input id=highlight type=button value="Highlight Code Dark" class=pure-button style=font-size:65%;background:#999;text-align:center></div></div><div id=main><main><div class=header><h2>Configure CI for Python app in Azure Devops (Pytest, Nexus IQ, SonarQube)</h2><h3></h3></div><div class=content><div class=post-meta><div class=dark-color><i class="fa fa-calendar fa-fw"></i>
<time>05 Jan 2024</time>
.. <i class="fa fa-clock-o" aria-hidden=true>3 min</i></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=https://pbedn.github.io/tags/azure>azure</a>&nbsp;/
<a class=post-taxonomy-tag href=https://pbedn.github.io/tags/nexusiq>nexusiq</a>&nbsp;/
<a class=post-taxonomy-tag href=https://pbedn.github.io/tags/sonarqube>sonarqube</a>&nbsp;/
<a class=post-taxonomy-tag href=https://pbedn.github.io/tags/python>python</a>&nbsp;/
<a class=post-taxonomy-tag href=https://pbedn.github.io/tags/pytest>pytest</a></div></div><p>Example of Azure Pipeline yaml file to configure pytest with code coverage and Nexus IQ / SonarQube scanners for Python application.</p><p>Additional yaml file features:</p><ul><li>trigger CI on merge to master, or each tag</li><li>pip download folder caching</li><li>freeze requirements and add marker for selected platform as recommended in Nexux docs</li><li>publish test result</li><li>publish code coverage report using Cobertura tool</li></ul><p>Notes:</p><ul><li>overall time save is neglible compared to regular <em>pip install</em> for small requirements file</li><li>azure pipeline file grows quickly, so if using similar in multiple repositories it is worth to implement pipeline templates</li><li>Sonar and Nexus are configured to run only on merge to master</li></ul><p>Azure Devops configuration for SonarQube and Sonata Nexus:</p><ul><li><a href=https://docs.sonarsource.com/sonarqube/latest/devops-platform-integration/azure-devops-integration/>Link to docs: Azure - SonarQube</a></li><li><a href=https://help.sonatype.com/iqserver/integrations/plugins-for-continuous-integration-platforms/nexus-iq-for-azure-devops>Link to docs: Azure - Nexus IQ</a></li></ul><p>Example app structure:</p><pre tabindex=0><code>src\
  core\
  core2\
  utils\
  resources\
tests\
  testcore\
  testsutils\
requirements.txt
</code></pre><p>Example Azure CI pipeline file:</p><pre tabindex=0><code># azure-pipeline.yml

trigger:
  branches:
    include:
      - master
  tags:
    include:
      - &#39;*&#39;

resources:
  repositories:
    - repository: self
      type: git
      name: &lt;put-here-name-of-repository&gt;

variables:
  pythonVersion: &#39;3.11&#39;
  pipDownloadDir: $(Pipeline.Workspace)/.pip

jobs:
  - job: Test
    pool:
      name: &#39;Azure Pipelines&#39;
      vmImage: ubuntu-latest
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: $(pythonVersion)
    
      - task: Cache@2
        displayName: Load cache
        inputs:
          key: &#39;pip | &#34;$(Agent.OS)&#34; | requirements.txt&#39;
          path: $(pipDownloadDir)
          cacheHitVar: cacheRestored
    
      - script: pip download -r requirements.txt --dest=$(pipDownloadDir)
        displayName: &#39;Download requirements&#39;
        condition: eq(variables.cacheRestored, &#39;false&#39;)

      - script: pip install -r requirements.txt --no-index --find-links=$(pipDownloadDir)
        displayName: &#39;Install requirements&#39;

      - script: |
          mkdir -p dist
          pip freeze &gt; frozen_req.txt
          cat frozen_req.txt | while read line; do echo ${line}&#39;; sys_platform=&#34;linux&#34;&#39; &gt;&gt; frozen_req_sys.txt; done
          mv frozen_req_sys.txt dist/requirements.txt
        displayName: &#39;Prepare files for Nexus scanning&#39;
    
      - script: pytest -vs --junitxml=junit/test-results.xml --cov=src --cov-report=xml tests/
        displayName: &#39;Run tests with coverage&#39;

      - script: cp coverage.xml dist/coverage.xml
        displayName: &#39;Copy coverage report for Sonar&#39;
    
      - task: PublishTestResults@1
        condition: succeededOrFailed()
        inputs:
          testResultsFiles: &#39;junit/**.xml&#39;
          testRunTitle: &#39;Publish test results&#39;

      - task: PublishCodeCoverageResults@1
        inputs:
          codeCoverageTool: Cobertura
          summaryFileLocation: &#39;$(System.DefaultWorkingDirectory)/coverage.xml&#39;
    
      - publish: $(System.DefaultWorkingDirectory)/dist
        artifact: dist
        displayName: &#39;Publish files for scanning&#39;

  - job: Sonar
    dependsOn: Test
    condition: and(succeded(), eq(variables[&#39;build.sourceBranch&#39;], &#39;refs/heads/master&#39;))
    pool:
      name: &#39;Azure Pipelines&#39;
      vmImage: ubuntu-latest
    steps:
      - task: DownloadPipelineArtifact@2
        inputs:
          source: current
          artifact: dist
          path: $(System.DefaultWorkingDirectory)
    
      - task: SonarQubePrepare@5
        inputs:
            SonarQube: &#39;YourSonarqubeServerEndpoint&#39;
            scannerMode: &#39;Other&#39;
            extraProperties: |
              sonar.projectKey=&lt;your-application-name&gt;.$(Build.Repository.Name) 
              sonar.verbose=true
              sonar.sources=src/
              sonar.tests=tests/
              sonar.exclusions=src/noncore/**,src/resources/**
              sonar.python.version=$(pythonVersion)
              sonar.python.coverage.reportPaths=coverage.xml
              sonar.coverage.exclusions=src/noncore/**/*,src/resources/**/*

        # Run Code Analysis task
        - task: SonarQubeAnalyze@5

        # Publish Quality Gate Result task
        - task: SonarQubePublish@5
          inputs:
            pollingTimeoutSec: &#39;300&#39;

  - job: NexusIQ
    dependsOn: Test
    condition: and(succeded(), eq(variables[&#39;build.sourceBranch&#39;], &#39;refs/heads/master&#39;))
    pool:
      name: &#39;Azure Pipelines&#39;
      vmImage: ubuntu-latest
    steps:
      - task: DownloadPipelineArtifact@2
        inputs:
          source: current
          artifact: dist
          path: $(System.DefaultWorkingDirectory)
    - checkout: none
    - bash: ls -lRH
      displayName: Show local files
    - task: NexusIqPipelineTask@1
      displayName: Nexus IQ Scan
      continueOnError: true
      inputs:
        nexusIqService: &#39;Nexus Iq&#39;
        applicationId: &lt;your-application-name&gt;.$(Build.Repository.Name)
        stage: &#39;Build&#39;
        scanTargets: &#39;$(System.DefaultWorkingDirectory)/**/*.*&#39;
</code></pre><div class="prev-next-post pure-g"><div class=pure-u-1-24 style=text-align:left><a href=https://pbedn.github.io/post/2023-05-15-journey-around-ubuntu-2023/><i class="fa fa-chevron-left"></i></a></div><div class=pure-u-10-24><nav class=prev><a href=https://pbedn.github.io/post/2023-05-15-journey-around-ubuntu-2023/>Journey around Ubuntu distributions in 2023</a></nav></div><div class=pure-u-2-24>&nbsp;</div><div class=pure-u-10-24></div><div class=pure-u-1-24 style=text-align:right></div></div></div></main></div></div><footer><script src=https://pbedn.github.io/js/ui.js></script><script src=https://pbedn.github.io/js/menus.js></script><script type=text/javascript>$("#highlight").click(function(){$("head").append('<link href="https://pbedn.github.io/css/atom-one-dark.css" rel="stylesheet" id="mycss"/>')})</script></footer></body></html>