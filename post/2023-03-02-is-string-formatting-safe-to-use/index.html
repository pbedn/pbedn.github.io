<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.128.0"><title>Is string formatting in Python safe to use or not? &#183; Coding Notes</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.6/pure-min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.6/grids-responsive-min.css><link rel=stylesheet href=https://pbedn.github.io/css/side-menu.css><link rel=stylesheet href=https://pbedn.github.io/css/blackburn.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js></script><link rel="shortcut icon" href=https://pbedn.github.io/img/favicon.ico type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVR0TPVEEJ"></script><script>if(window.location.hostname!="localhost"){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JVR0TPVEEJ")}</script></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=https://pbedn.github.io/>PBedn</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://pbedn.github.io/><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://pbedn.github.io/archives/><i class='fa fa-list fa-fw'></i>Archives</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://pbedn.github.io/about/><i class='fa fa-user fa-fw'></i>About</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://pbedn.github.io/projects/><i class='fa fa-cog fa-fw'></i>Projects</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://pbedn.github.io/books/><i class='fa fa-book fa-fw'></i>Books</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://linkedin.com/in/pbedn target=_blank><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://github.com/pbedn target=_blank><i class="fa fa-github-square fa-fw"></i>GitHub</a></li></ul></div><div><div class=small-print><small>&#169; 2021 Pawel Bednarz</small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div></div><div><input id=highlight type=button value="Highlight Code Dark" class=pure-button style=font-size:65%;background:#999;text-align:center></div></div><div id=main><main><div class=header><h2>Is string formatting in Python safe to use or not?</h2><h3></h3></div><div class=content><div class=post-meta><div class=dark-color><i class="fa fa-calendar fa-fw"></i>
<time>02 Mar 2023</time>
.. <i class="fa fa-clock-o" aria-hidden=true>3 min</i></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=https://pbedn.github.io/tags/python>python</a></div></div><p>The mighty and powerful f-strings. Well, they are only a sugar syntax on string.format, but whatever. Here I will look at one of the usage scenarios that you should not commit - taking format string from the user. Well, I had to do it in my project, so&mldr;</p><h4 id=easy-what-is-an-f-string>Easy, what is an f-string?</h4><p>Literal string prefixed with <em>f</em> with expression inside curly braces.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Pawel&#39;</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;My name is </span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><h4 id=next-level-f-strings>Next level, f-strings:</h4><ul><li>are evaluated at runtime</li><li>are parsed into literal strings and expressions</li><li>use the same format specifier mini-language as <em>str.format</em></li><li>has full access to local and global variables</li><li>can run any valid Python expression, including function and method calls (ast.parse etc.)</li><li>can use lambdas.. game over.</li></ul><h4 id=security-issues>Security issues?</h4><p>Some prominent Python community personalities-celebrities observed that The F&rsquo;s could be misused. That is a fact. There are a few ways to do it:</p><ul><li>denial of service attack by a large string size</li><li>using F&rsquo;s in logging in wrong way (<a href=https://github.com/python/cpython/issues/90358 target=_blank>read me</a>)</li><li>accessing attributes within an object, especially if it holds some kind of secrets (web dev)</li><li>in general, user-supplied format string could inject unwanted code</li></ul><p>Try that in your interpreter:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Goodbye! </span><span style=color:#e6db74>{</span>exit()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> BOOM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># on the other hand this will not work when using string.format</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;{exit()}&#34;</span><span style=color:#f92672>.</span>format(exit()<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) <span style=color:#75715e># SyntaxError</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;{exit()}&#34;</span><span style=color:#f92672>.</span>format(exit<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) <span style=color:#75715e># KeyError</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;{exit()}&#34;</span><span style=color:#f92672>.</span>format() <span style=color:#75715e># KeyError</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(exit) <span style=color:#75715e># This will but is a different case than we talk about in this post</span>
</span></span></code></pre></div><p>So is this a problem?
Yes and no. Depends on the context and place where it is executed.</p><h4 id=my-application>My application</h4><p>I had a service that would read configuration files created by another team, and the clue was that they could put an array in yaml in such a form: *key: <em>"{value}"</em>, where <em>{value}</em> would be used later for dynamic lookup in some data. Thanks to that I would not have to know the keys and values beforehand in my code. But what if user consciously or not will give me a bad input like one showed below in <em>conf.yaml</em>?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># conf.yaml</span>
</span></span><span style=display:flex><span>some-data:
</span></span><span style=display:flex><span> - key: <span style=color:#e6db74>&#34;{value}&#34;</span>
</span></span><span style=display:flex><span> - foo: <span style=color:#e6db74>&#34;{another} {self.secret} {exit()} {locals()}&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#app.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> string <span style=color:#f92672>import</span> Formatter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>formatter <span style=color:#f92672>=</span> Formatter()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>resolved_fields_dict <span style=color:#f92672>=</span> dict()
</span></span><span style=display:flex><span>external_data_source <span style=color:#f92672>=</span> dict(foo<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user_format_string <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{foo}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{bar}</span><span style=color:#e6db74>&#34;</span> <span style=color:#75715e># This comes from conf.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Extract field from format string</span>
</span></span><span style=display:flex><span>fields <span style=color:#f92672>=</span> [field <span style=color:#66d9ef>for</span> _, field, _, _ <span style=color:#f92672>in</span> formatter<span style=color:#f92672>.</span>parse(user_format_string) <span style=color:#66d9ef>if</span> field]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># In: fields</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Out: [&#39;foo&#39;, &#39;bar&#39;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Update my dict from external data if exists, otherwise use the default</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> field <span style=color:#f92672>in</span> fields:
</span></span><span style=display:flex><span>    resolved_fields_dict[field] <span style=color:#f92672>=</span> external_data_source<span style=color:#f92672>.</span>get(field, <span style=color:#e6db74>&#34;Not Found&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># In: resolved_fields_dict</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Out: {&#39;foo&#39;: 1, &#39;bar&#39;: &#39;Not Found&#39;}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Finally return</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> user_format_string<span style=color:#f92672>.</span>format(<span style=color:#f92672>**</span>resolved_fields_dict)
</span></span><span style=display:flex><span><span style=color:#75715e># Out: &#39;1 Not Found&#39;</span>
</span></span></code></pre></div><p>And while I am not afraid the other team would want to hack me, they could inject by mistake some bad input and make my Python throw various errors.</p><h4 id=solution>Solution</h4><p>I used a customised string.Formatter in yaml config parser with overrided <em>get_field</em> method. This is based on an example found in <a href=https://stackoverflow.com/questions/15356649/can-pythons-string-format-be-made-safe-for-untrusted-format-strings target=_blank>stackoverflow</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> string <span style=color:#f92672>import</span> Formatter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SafeFormatter</span>(Formatter):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_field</span>(self, field_name, args, kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>in</span> field_name <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;[&#39;</span> <span style=color:#f92672>in</span> field_name:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> InsecureStringFormatError(<span style=color:#e6db74>&#39;Invalid format string.&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>get_field(field_name,args,kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>formatter <span style=color:#f92672>=</span> SafeFormatter()
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    formatter<span style=color:#f92672>.</span>format(<span style=color:#e6db74>&#34;{sys.exit()&#34;</span>}, num<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, id<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;hello&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> InsecureStringFormatError:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Hack the world&#34;</span>)
</span></span></code></pre></div><p>Now we can catch and handle bad input early.</p><h4 id=conclusions>Conclusions</h4><ul><li>Do not take format string from the user, and if you have to then do not use f-strings</li><li>string.Formatter could be used to create custom validations</li></ul><hr><p>Resources:</p><ul><li><a href=https://peps.python.org/pep-0498/ target=_blank>PEP 498 – Literal String Interpolation</a></li><li><a href=https://github.com/python/cpython/issues/90358 target=_blank>Discourage logging f-strings due to security considerations</a></li><li><a href=https://stackoverflow.com/questions/15356649/can-pythons-string-format-be-made-safe-for-untrusted-format-strings target=_blank>[SO] Can Python&amp;rsquo;s string .format() be made safe for untrusted format strings</a></li></ul><div class="prev-next-post pure-g"><div class=pure-u-1-24 style=text-align:left><a href=https://pbedn.github.io/post/2023-01-30-pytest-parametrizing-scope/><i class="fa fa-chevron-left"></i></a></div><div class=pure-u-10-24><nav class=prev><a href=https://pbedn.github.io/post/2023-01-30-pytest-parametrizing-scope/>Using scopes in Pytest fixtures</a></nav></div><div class=pure-u-2-24>&nbsp;</div><div class=pure-u-10-24><nav class=next><a href=https://pbedn.github.io/post/2023-04-20-ubuntu-mate-on-thinkpad-t470-in-2023/>Ubuntu Mate 22.04 on Thinkpad T470</a></nav></div><div class=pure-u-1-24 style=text-align:right><a href=https://pbedn.github.io/post/2023-04-20-ubuntu-mate-on-thinkpad-t470-in-2023/><i class="fa fa-chevron-right"></i></a></div></div></div></main></div></div><footer><script src=https://pbedn.github.io/js/ui.js></script><script src=https://pbedn.github.io/js/menus.js></script><script type=text/javascript>$("#highlight").click(function(){$("head").append('<link href="https://pbedn.github.io/css/atom-one-dark.css" rel="stylesheet" id="mycss"/>')})</script></footer></body></html>